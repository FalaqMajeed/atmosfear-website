<!-- Country Profile Tool Section -->
<section id="data-tool-section" class="section data-tool-section">
    <div class="container">
        <h2 class="section-title fade-in">Country Profile Tool</h2>
        <p class="section-subtitle fade-in">
            Explore predicted health impacts from PM₂.₅ by selecting a country and year
        </p>

        <div class="tool-grid">
            <!-- Input Form -->
            <div class="tool-card fade-in interactive-element">
                <h3><i class="fas fa-globe icon"></i> Select Parameters</h3>
                <div class="form-group">
                    <label for="country">Country</label>
                    <select id="country" class="form-control" style="height: auto;" placeholder="Select or type to search">
                        <option value="">Select a country...</option>
                        <!-- Countries populated by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <select id="year" class="form-control">
                        <option value="">Select a year...</option>
                        <!-- Years populated by JavaScript -->
                    </select>
                </div>
                <button id="predictBtn" class="predict-button">Generate Profile</button>
                <p id="loadingMessage" style="display: none; font-size: 0.9rem; color: #64748b; margin-top: 1rem;">
                    <i class="fas fa-spinner fa-spin"></i> Loading data...
                </p>
            </div>

            <!-- Result Display -->
            <div class="result-card fade-in interactive-element" id="result">
                <div class="result-placeholder" id="placeholder">
                    <i class="fas fa-chart-line"></i>
                    <h4>No results yet</h4>
                    <p>Select a country and year, then press "Generate Profile".</p>
                </div>
                <div class="result-content" id="resultContent"></div>
            </div>
        </div>
    </div>
</section>

<script>
// Complete list of 195 countries from your dataset
const validCountries = [
    "Afghanistan", "Albania", "Algeria", "Angola", "Argentina", "Armenia",
    "Australia", "Austria", "Azerbaijan", "Bangladesh", "Belarus", "Belgium",
    "Benin", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil",
    "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada",
    "Central African Republic", "Chad", "Chile", "China", "Colombia", "Congo",
    "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark",
    "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Eritrea",
    "Estonia", "Ethiopia", "Finland", "France", "Gabon", "Gambia", "Georgia",
    "Germany", "Ghana", "Greece", "Guatemala", "Guinea", "Guinea-Bissau",
    "Haiti", "Honduras", "Hungary", "India", "Indonesia", "Iran", "Iraq",
    "Ireland", "Israel", "Italy", "Ivory Coast", "Jamaica", "Japan", "Jordan",
    "Kazakhstan", "Kenya", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon",
    "Lesotho", "Liberia", "Libya", "Lithuania", "Luxembourg", "Madagascar",
    "Malawi", "Malaysia", "Mali", "Malta", "Mauritania", "Mexico", "Moldova",
    "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia",
    "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria",
    "North Korea", "Norway", "Oman", "Pakistan", "Panama", "Papua New Guinea",
    "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Romania",
    "Russia", "Rwanda", "Saudi Arabia", "Senegal", "Serbia", "Sierra Leone",
    "Singapore", "Slovakia", "Slovenia", "Somalia", "South Africa", "South Korea",
    "South Sudan", "Spain", "Sri Lanka", "Sudan", "Sweden", "Switzerland",
    "Syria", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tunisia", "Turkey",
    "Turkmenistan", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom",
    "United States", "Uruguay", "Uzbekistan", "Venezuela", "Vietnam", "Yemen",
    "Zambia", "Zimbabwe"
];



// SDI classification system
const sdiRanges = [
    { max: 0.45, label: "Low" },
    { max: 0.61, label: "Medium" },
    { max: 0.75, label: "High" },
    { max: 1.0, label: "Very High" }
];

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    const countrySelect = document.getElementById('country');
    const yearSelect = document.getElementById('year');
    
    // Populate country dropdown (sorted)
    validCountries.sort().forEach(country => {
        const option = document.createElement('option');
        option.value = country.toLowerCase();
        option.textContent = country;
        countrySelect.appendChild(option);
    });
    
    // Populate year dropdown (2010-2025)
    const currentYear = new Date().getFullYear();
    for (let year = 2010; year <= 2025; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
        
        if (year === currentYear) {
            option.selected = true;
        }
    }
    
    // Improved dropdown behavior
    let isUserTyping = false;
    
    countrySelect.addEventListener('focus', function() {
        this.size = 5;
        Array.from(this.options).forEach(opt => opt.style.display = '');
    });
    
    countrySelect.addEventListener('blur', function() {
        this.size = 1;
        isUserTyping = false;
    });
    
    countrySelect.addEventListener('input', function() {
        isUserTyping = true;
        const searchTerm = this.value.toLowerCase();
        Array.from(this.options).forEach(option => {
            option.style.display = option.value === '' || 
                                 option.textContent.toLowerCase().includes(searchTerm) 
                                 ? '' : 'none';
        });
    });
    
    countrySelect.addEventListener('change', function() {
        if (!isUserTyping) {
            Array.from(this.options).forEach(opt => opt.style.display = '');
        }
        isUserTyping = false;
    });
    
    countrySelect.addEventListener('mousedown', function() {
        Array.from(this.options).forEach(opt => opt.style.display = '');
    });
});

// Get SDI level description
function getSdiLevel(sdiValue) {
    for (const range of sdiRanges) {
        if (sdiValue <= range.max) {
            return range.label;
        }
    }
    return "Unknown";
}

// Prediction function
document.getElementById("predictBtn").addEventListener("click", async function() {
    const country = document.getElementById("country").value.trim();
    const year = document.getElementById("year").value.trim();
    const resultDiv = document.getElementById("resultContent");
    const placeholder = document.getElementById("placeholder");
    const loadingMessage = document.getElementById('loadingMessage');
    
    if (!country || !year) {
        alert("Please select both country and year.");
        return;
    }
    
    try {
        // Show loading state
        placeholder.style.display = "none";
        loadingMessage.style.display = 'block';
        resultDiv.innerHTML = '';
        resultDiv.classList.add("active");
        
        // Call your API endpoint
        const response = await fetch(`https://atmosfear.up.railway.app/atmosfear?country=${country}&year=${year}`);
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        loadingMessage.style.display = 'none';
        
        // Build results display
        let html = `
            <h3 style="text-align:center; margin-bottom:1.5rem; color:#22d3ee;">
                <i class="fas fa-chart-pie" style="margin-right: 0.5rem;"></i>
                Health Profile for <span style="color:#fbbf24;">${data.country}</span> in ${data.year}
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
        `;
        
        data.output.forEach(item => {
            const sdiLevel = getSdiLevel(item["SDI"]);
            html += `
                <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 10px; border-left: 4px solid #22d3ee;">
                    <h4 style="color: #fbbf24; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-${getIconForCategory(item['DALY Outcome'])}"></i>
                        ${item["DALY Outcome"]}
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">PM₂.₅ Level</div>
                            <div style="font-weight: bold; color: white;">${item["PM2.5"].toFixed(2)} µg/m³</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">Predicted DALYs</div>
                            <div style="font-weight: bold; color: white;">${item["Predicted DALY"].toFixed(2)} per 100k</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <div style="font-size: 0.8rem; color: #94a3b8;">Development Index (SDI)</div>
                        <div style="font-weight: bold; color: white;">
                            ${item["SDI"].toFixed(3)} 
                            <span style="font-size: 0.9rem; color: #fbbf24;">(${sdiLevel})</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Add SDI and DALY explanations
        html += `
            </div>
            <div style="margin-top: 2rem; background: rgba(34, 211, 238, 0.1); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #22d3ee;">
                <h4 style="color: #22d3ee; margin-bottom: 1rem;">
                    <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                    Understanding the Metrics
                </h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div>
                        <h5 style="color: #fbbf24; margin-bottom: 0.5rem;">SDI Levels</h5>
                        <ul style="color: #e2e8f0; font-size: 0.9rem; line-height: 1.6; padding-left: 1.2rem;">
                            <li><strong>0.0 - 0.45:</strong> Low development</li>
                            <li><strong>0.45 - 0.61:</strong> Medium development</li>
                            <li><strong>0.61 - 0.75:</strong> High development</li>
                            <li><strong>0.75 - 1.0:</strong> Very high development</li>
                        </ul>
                    </div>
                    <div>
                        <h5 style="color: #fbbf24; margin-bottom: 0.5rem;">DALY Meaning</h5>
                        <p style="color: #e2e8f0; font-size: 0.9rem; line-height: 1.6;">
                            <strong>Disability-Adjusted Life Years</strong> measure overall disease burden, 
                            representing years lost due to ill-health, disability, or early death. 
                            Lower values indicate better population health.
                        </p>
                    </div>
                </div>
            </div>
        `;
        
        resultDiv.innerHTML = html;
        
    } catch (error) {
        loadingMessage.style.display = 'none';
        resultDiv.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #ef4444;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <h4>Error Loading Data</h4>
                <p>${error.message || 'Failed to fetch data from the server'}</p>
                <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Try Again
                </button>
            </div>
        `;
    }
});

// Helper function to get icons for health categories
function getIconForCategory(category) {
    if (category.includes('Cardiovascular')) return 'heartbeat';
    if (category.includes('Respiratory')) return 'lungs';
    if (category.includes('Stroke')) return 'brain';
    if (category.includes('COVID')) return 'virus';
    return 'chart-line';
}
</script>